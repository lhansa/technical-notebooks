{
  "hash": "5154ac1af0f6f0b71ec0b3cedd5d5300",
  "result": {
    "markdown": "---\ntitle: \"Cómo aplicar non standard evaluation con dplyr y rlang\"\ndescription: \"Cómo aplicar non standard evaluation con dplyr y rlang\"\ndescription-meta: \"Cómo aplicar non standard evaluation con dplyr y rlang\"\nauthor: \"Leonardo Hansa\"\ndate: \"2024-04-22\"\ncategories: [datos]\nexecute: \n  echo: true\n  message: false\n  warning: false\nfreeze: true\n---\n\n\nTengo datos de empleos en el sector público y privado del INE. Y los quiero explorar con dplyr y ggplot2.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(readr)\nlibrary(stringr)\nlibrary(ggplot2)\ntheme_set(theme_light())\n```\n:::\n\n\n\nLeer los ficheros del INE siempre es aventura con sus formatos, pero aquí tienes el código.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_empleo <- readr::read_csv2(\"../../data/4262.csv\", \n                              show_col_types = FALSE,\n                              locale = locale(encoding = \"latin1\"))\n\ndf_empleo <- janitor::clean_names(df_empleo) |> \n  rename(ccaa = comunidades_y_ciudades_autonomas)\n\nhead(df_empleo)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 5\n  ccaa         sexo    tipo_de_sector periodo total\n  <chr>        <chr>   <chr>          <chr>   <dbl>\n1 01 Andalucía Hombres Empleo público 2023T4   286.\n2 01 Andalucía Hombres Empleo público 2023T3   298.\n3 01 Andalucía Hombres Empleo público 2023T2   289 \n4 01 Andalucía Hombres Empleo público 2023T1   294.\n5 01 Andalucía Hombres Empleo público 2022T4   297 \n6 01 Andalucía Hombres Empleo público 2022T3   299 \n```\n:::\n:::\n\n\n\n\n## Una exploración rápida\n\nEsto es lo que te planteo explorar: una agregación trimestral por tipo de sector.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_agg <- df_empleo |>\n  group_by(periodo, tipo_de_sector) |> \n  summarise(total = sum(total), .groups = \"drop\") |> \n  convierte_periodo() # función propia para convertir a fecha\n\ndf_agg\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 24 × 3\n   periodo    tipo_de_sector  total\n   <date>     <chr>           <dbl>\n 1 2021-01-01 Empleo privado 15809.\n 2 2021-01-01 Empleo público  3397.\n 3 2021-04-01 Empleo privado 16232.\n 4 2021-04-01 Empleo público  3440.\n 5 2021-07-01 Empleo privado 16547.\n 6 2021-07-01 Empleo público  3484.\n 7 2021-10-01 Empleo privado 16709.\n 8 2021-10-01 Empleo público  3476.\n 9 2022-01-01 Empleo privado 16617.\n10 2022-01-01 Empleo público  3468.\n# ℹ 14 more rows\n```\n:::\n:::\n\n\nQue devuelve un gráfico así.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(df_agg) + \n  geom_line(aes(x = periodo, y = total, col = tipo_de_sector)) + \n  scale_color_discrete(\"Tipo de empleo\") + \n  labs(\n    x = \"Trimestre\", y = \"Empleados\", \n    title = \"Evolución trimestral de empleados privados y públicos\", \n    caption = \"Fuente: INE\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/grafico-1.png){width=672}\n:::\n:::\n\n\n## Más libertad\n\nAhora voy a preparar una función para que un usuario pueda elegir una columna más con la que agregar.\n\nLo que quiero es una función con la que funcione un código así:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nagrega_empleo(sexo)\n```\n:::\n\n\nSi intentas plantear eso solo con dplyr te dará un error diciendo que cierto objeto no es nada. En el código siguiente, `grouping_var` no sería nada sino fuera por esa combinación de `enquo()` con otros elementos.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rlang)\n\nagrega_empleo <- function(grouping_var) {\n  nombre_metrica <- as_name(enquo(grouping_var))\n  nombre_metrica <- paste0(\"total_por_\", nombre_metrica)\n  df_empleo |>\n    group_by(periodo, tipo_de_sector, !!enquo(grouping_var)) |> \n    summarise(!!nombre_metrica := sum(total), .groups = \"drop\") |> \n    convierte_periodo() \n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nagrega_empleo(ccaa)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 456 × 4\n   periodo    tipo_de_sector ccaa                       total_por_ccaa\n   <date>     <chr>          <chr>                               <dbl>\n 1 2021-01-01 Empleo privado 01 Andalucía                        2469.\n 2 2021-01-01 Empleo privado 02 Aragón                            451.\n 3 2021-01-01 Empleo privado 03 Asturias, Principado de           294 \n 4 2021-01-01 Empleo privado 04 Balears, Illes                    416 \n 5 2021-01-01 Empleo privado 05 Canarias                          626 \n 6 2021-01-01 Empleo privado 06 Cantabria                         190.\n 7 2021-01-01 Empleo privado 07 Castilla y León                   752 \n 8 2021-01-01 Empleo privado 08 Castilla - La Mancha              658.\n 9 2021-01-01 Empleo privado 09 Cataluña                         2913.\n10 2021-01-01 Empleo privado 10 Comunitat Valenciana             1671.\n# ℹ 446 more rows\n```\n:::\n:::\n\n\nEn lo anterior, `!!enquo()` se encarga de evaluar la expresión dentro de grouping_var (`ccaa` en este caso) en el entorno adecuado.\n\nSi tienes muchas variables, necesitarás algo como lo siguiente (aunque aún no sé cómo afecta eso entonces a los nombres de nuevas columnas).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nagrega_empleo <- function(...) {\n  df_empleo |>\n    group_by(periodo, tipo_de_sector, !!!enquos(...)) |> \n    summarise(total= sum(total), .groups = \"drop\") |> \n    convierte_periodo() \n}\n\nagrega_empleo(ccaa, sexo)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 912 × 5\n   periodo    tipo_de_sector ccaa                       sexo    total\n   <date>     <chr>          <chr>                      <chr>   <dbl>\n 1 2021-01-01 Empleo privado 01 Andalucía               Hombres 1474 \n 2 2021-01-01 Empleo privado 01 Andalucía               Mujeres  995.\n 3 2021-01-01 Empleo privado 02 Aragón                  Hombres  268 \n 4 2021-01-01 Empleo privado 02 Aragón                  Mujeres  183.\n 5 2021-01-01 Empleo privado 03 Asturias, Principado de Hombres  164.\n 6 2021-01-01 Empleo privado 03 Asturias, Principado de Mujeres  130.\n 7 2021-01-01 Empleo privado 04 Balears, Illes          Hombres  233.\n 8 2021-01-01 Empleo privado 04 Balears, Illes          Mujeres  183.\n 9 2021-01-01 Empleo privado 05 Canarias                Hombres  335.\n10 2021-01-01 Empleo privado 05 Canarias                Mujeres  291.\n# ℹ 902 more rows\n```\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}