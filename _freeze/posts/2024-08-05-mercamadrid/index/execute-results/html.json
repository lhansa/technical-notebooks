{
  "hash": "f558a32c7a290c70c370c7740ce3590c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Mercamadrid\"\ndescription: \"Exploración de datos públicos de mercamadrid\"\ndescription-meta: \"Exploración de datos públicos de mercamadrid\"\nauthor: \"Leonardo Hansa\"\ndate: \"2024-08-05\"\ncategories: [exploraciones]\nexecute: \n  echo: true\n  message: false\n  warning: false\nfreeze: true\n---\n\n\n\n## Lectura de datos \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readr)\nlibrary(purrr)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(ggplot2)\n\nggplot2::theme_set(ggplot2::theme_light())\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlink_base <- \"https://datos.madrid.es/egob/catalogo/300357-%s-mercamadrid-volumen-precio.csv\"\nlinks <- sprintf(link_base, seq(0, 10, 2))\n\ndf_merca <- map_dfr(links, function(link) {\n  if (RCurl::url.exists(link)) {\n    datos <- read_csv2(\n      link,\n      locale = locale(encoding = \"latin1\"),\n      show_col_types = FALSE\n    )\n\n    datos <- janitor::clean_names(datos)\n\n    if (is.character(datos$fecha_desde)) {\n      datos <- datos |>\n        mutate(across(\n          contains(\"precio\"),\n          \\(x) parse_number(x, na = c(\"Precio Más Frecuente\", \"Precio Máximo\", \"Precio Mínimo\"))\n        ))\n    }\n\n    if (is.character(datos$kilos)) {\n      datos <- datos |>\n        mutate(\n          kilos = parse_number(kilos, na = \"Kilos\")\n        )\n    }\n\n    datos <- datos |>\n      mutate(\n        across(\n          contains(\"fecha\"),\n          \\(x) as.Date(as.character(x), format = \"%Y%m%d\")\n        ), \n        origen = as.character(origen)\n      )\n\n    return(datos)\n  }\n})\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n\ndf_merca <- select(df_merca, -origen)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_merca |> \n    distinct(descripcion_variedad)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 754 × 1\n   descripcion_variedad \n   <chr>                \n 1 VACUNO CANAL         \n 2 VACUNO DESPIECE AÑOJO\n 3 VACUNO DESPIECE VACA \n 4 VACUNO CASQUERIA     \n 5 VACUNO ELABORADO     \n 6 VACUNO PRECOCINADO   \n 7 OVINO CANAL          \n 8 OVINO DESPIECE       \n 9 OVINO CASQUERIA      \n10 OVINO ELABORADO      \n# ℹ 744 more rows\n```\n\n\n:::\n:::\n\n\n\n## Vacuno\n\nHay mil cosas. Voy a ver qué puedo sacar solo del vacuno por ahora.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_vacuno <- df_merca |>\n  filter(str_detect(descripcion_variedad, \"^VACUNO\"))\n```\n:::\n\n\n\n### Qué variedad de vacuno se vende más\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_vacuno |> \n  group_by(fecha_desde, descripcion_variedad) |> \n  summarise(kilos = sum(kilos, na.rm = TRUE), .groups = \"drop\") |> \n  ggplot() + \n  geom_line(aes(x = fecha_desde, y = kilos, col = descripcion_variedad))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/evolucion-variedad-1.png){width=672}\n:::\n:::\n\n\n\n**¿Qué será `VACUNO FRESCO`?**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_vacuno_variedades <- df_vacuno |>\n  group_by(fecha_desde, descripcion_variedad) |>\n  summarise(kilos = sum(kilos, na.rm = TRUE), .groups = \"drop\") |>\n  group_by(descripcion_variedad) |>\n  summarise(kilos_mes = sum(kilos) / n())\n\nggplot(df_vacuno_variedades) +\n  geom_col(\n    aes(x = reorder(descripcion_variedad, kilos_mes), y = kilos_mes),\n    fill = \"#800080\"\n  ) +\n  labs(x = \"\", y = \"Kilos por mes\") +\n  coord_flip() \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/distribucion-variedad-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nvariedades_principales <- df_vacuno_variedades |>\n  slice_max(order_by = kilos_mes, n = 4) |>\n  pull(descripcion_variedad)\n\ndf_vacuno |>\n  filter(descripcion_variedad %in% variedades_principales) |>\n  group_by(fecha_desde, descripcion_variedad) |>\n  summarise(kilos = sum(kilos, na.rm = TRUE), .groups = \"drop\") |>\n  ggplot() +\n  geom_line(aes(x = fecha_desde, y = kilos, col = descripcion_variedad))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/evolucion-variedad2-1.png){width=672}\n:::\n:::\n\n\n\n### ¿De dónde ha venido el vacuno?\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_variedades_origen <- df_vacuno |>\n  filter(descripcion_variedad %in% variedades_principales) |>\n  group_by(descripcion_variedad, descripcion_origen) |>\n  summarise(kilos_mes = sum(kilos) / n(), .groups = \"drop\") |>\n  group_by(descripcion_variedad) |>\n  slice_max(order_by = kilos_mes, n = 5) |>\n  ungroup()\n\ndf_vacuno |>\n  semi_join(\n    df_variedades_origen,\n    by = c(\"descripcion_variedad\", \"descripcion_origen\")\n  ) |> \n  ggplot() + \n  geom_line(aes(x = fecha_desde, y = kilos, col = descripcion_origen)) + \n  facet_wrap(~descripcion_variedad, scales = \"free_y\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/origen-vacuno-1.png){width=672}\n:::\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}