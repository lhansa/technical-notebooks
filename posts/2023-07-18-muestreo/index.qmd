---
title: "Muestreo (I)"
description: "Un repaso a algunos conceptos introductorios al muestreo estad칤stico"
description-meta: "Explicaci칩n de conceptos sobre muestreo (sampling) estad칤stico"
author: "Leonardo Hansa"
date: "2023-07-18"
categories: [datos]
execute: 
  echo: false
freeze: auto
---

Vi en Twitter esto: 

<blockquote class="twitter-tweet"><p lang="es" dir="ltr">Las encuestas lo han dejado claro.<br>Saben lo que vas a votar.<br>Han decidido que el <a href="https://twitter.com/hashtag/23J?src=hash&amp;ref_src=twsrc%5Etfw">#23J</a> PP y Vox gobernar치n este pa칤s.<br>쯈uito importancia a sus estimaciones?<br>No, porque generalizan la opini칩n de que no hay nada que hacer.<br>Pero no es cierto. <br>No hay nada escrito.<br>Si votamos, ganamos <a href="https://t.co/LUFoLm3WHT">pic.twitter.com/LUFoLm3WHT</a></p>&mdash; Carlos S치nchez Mato游댵九勇 (@carlossmato) <a href="https://twitter.com/carlossmato/status/1681041667573334019?ref_src=twsrc%5Etfw">July 17, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

쮼s in칰til el muestreo? 

Si lo haces mal, s칤. Como todo. 

Repaso algunos conceptos relacionados con el muestreo, sacados principalmente del curso de _Sampling with R_ de Datacamp. 

## De qu칠 sirve el muestreo

Antes de las elecciones se hacen encuestas sobre intenci칩n de voto. 쯈u칠 se te viene a la mente con estas encuestas?

Pues que nunca te preguntan a ti. 

(S칤, ya, justo quiz치 a ti s칤, una vez... pero no suele ocurrir. Lo normal es que nunca te hayan preguntado). 

A la mayor칤a de las personas no les preguntan nada. 

Pero un muestreo adecuado puede hacer que eso tenga valor. 

Es m치s, **un muestreo puede ser tu 칰nica opci칩n para estudiar unos datos.**

- En un caso como el de las encuestas, no tienen recursos para encuestar a todos los votantes de un pa칤s como, pongamos, Espa침a ([unos 37 millones de personas](https://www.boe.es/boe/dias/2019/12/02/pdfs/BOE-A-2019-17344.pdf))
- En un an치lisis de sangre, no estudian todos los litros de sangre de tu cuerpo: te sacan una muestra y generalizan (sacarte toda la sangre es peligroso: no lo intentes). 
- Si tienes una base de datos con millones de clientes, alg칰n algoritmo de _machine learning_ puede suponer mucha carga de trabajo para tu ordenador (no todos tenemos presupuesto para contratar servidores enormes en Amazon). )

쯊iene sentido siempre el muestreo? No. Si est치s corrigiendo unos ex치menes de unos alumnos, no tiene sentido que corrijas un porcentaje y extrapoles los dem치s por ahorrarte el tiempo. 

## Muestreo aleatorio sistem치tico

Si has estudiado algo de estad칤stica, te habr치s topado con el muestreo aleatorio. Consiste en seleccionar las observaciones para una muestra sin ning칰n criterio en concreto: esta s칤, esta no, esta s칤, esta tambi칠n porque s칤, esta no, esta tampoco...

Me gusta un [conjunto de datos con m칠tricas de ping칲inos](https://allisonhorst.github.io/palmerpenguins/) disponible en cualquier software estad칤stico que se precie. 


```{r}
#| label: datos
penguins <- palmerpenguins::penguins

knitr::kable(head(penguins))
```

Una de las m칠tricas que tiene es la longitud del pico, en mil칤metros. 

```{r}
#| label: histograma1

library(ggplot2)
theme_set(theme_light())
ggplot(penguins) + 
  geom_histogram(aes(x = bill_length_mm), fill = "#800080") + 
  xlim(c(30, 60))
```

쮺칩mo cambia eso si lo dibujas sobre una muestra aleatoria de los ping칲inos?

Lo primero es elegir la muestra aleatoria. Sup칩n que etiquetas a cada uno como 1, 2, 3... as칤 hasta 344, que son todos los ping칲inos que tienes. 

En el siguiente gr치fico tienes coloreados en azul los ping칲inos que eliges para tu muestra (50). 

```{r}
set.seed(800080)
filas <- sample(seq_len(nrow(penguins)), 50)
penguins$seleccionado <- FALSE
penguins$seleccionado[filas] <- TRUE
penguins$id <- seq_len(nrow(penguins))

ggplot(penguins) + 
  geom_col(aes(x = id, y = 1, fill = seleccionado))

```

쮺칩mo cambia la distribuci칩n de la longitud del pico en esta muestra? 

```{r}
#| label: hist2
ggplot(subset(penguins, seleccionado)) + 
  geom_histogram(aes(x = bill_length_mm), fill = "#800080") + 
  xlim(c(30, 60))
```

Hemos perdido valores extremos pero se mantiene una forma parecida. 

Un tipo diferente de muestreo es el sistem치tico, que consiste en hacer una selecci칩n basada en un criterio con respecto a la posici칩n de la observaci칩n en el conjunto de datos. En el siguiente gr치fico, pinto en azul al ping칲ino 1, 7, 13, etc... o sea, selecciono al primer ping칲ino de cada 6. 


```{r}
#| label: samplesist
div <- nrow(penguins) %/% 50

penguins$seleccionado2 <- FALSE
penguins$seleccionado2[seq_len(50) * div] <- TRUE

ggplot(penguins) + 
  geom_col(aes(x = id, y = 1, fill = seleccionado2))
```

```{r}
#| label: hist3
ggplot(subset(penguins, seleccionado2)) + 
  geom_histogram(aes(x = bill_length_mm), fill = "#800080") + 
  xlim(c(30, 60))
```

Aparte del caso extremo, la distribuci칩n no ha cambiado mucho, en parte porque la distribuci칩n de las observaciones no sigue ning칰n orden en concreto. Si tu tabla de datos sigue un orden, deber치s valorar si ese orden afecta al sistema que eliges para muestrear tus datos. 


## Muestreo estratificado

En el conjunto de datos tenemos tres especies de ping칲inos. 

```{r}
library(dplyr)
penguins |> 
  count(species) |> 
  ggplot(aes(x = reorder(species, n), y = n)) + 
  geom_col(fill = "#800080") +
  labs(x = "Especie", y = "Observaciones") + 
  coord_flip()
```

Algo habitual en _machine learning_ forzar a mantener esa proporci칩n diferente de especies en la muestra elegida, para que el conjunto de datos de trabajo mantenga esa distribuci칩n original. 

쯇ero qu칠 pasa si no quieres que as칤 sea? 

Imagina que est치s estudiando si una medicaci칩n es efectiva o no. Si mantienes la proporci칩n original, puede ser que de la especie menos representada (Chinstrap) te quedes casi sin muestra. 

Eso te puede venir mal, porque t칰 necesitas que haya muestra de todas las especies, para saber si en una especie el medicamento es m치s o menos efectivo. 

En un caso as칤, no querr칤as un muestreo estratificado, sino que forzar칤as incluso a que en la muestra, todos los grupos estuvieran igualmente representados. 

## C칩mo afecta el tama침o de la muestra

Cuando tienes a mano la poblaci칩n total, puedes comparar los c치lculos que hagas en tu muestra con los de la poblaci칩n (para cuando no tengas la poblaci칩n, te hablar칠 de esto en unos d칤as). 

En el caso de los ping칲inos, puedo calcular la media de la longitud del pico para la poblaci칩n: `r mean(penguins$bill_length_mm, na.rm = TRUE)`. 

O tambi칠n para la muestra que calcul칠 antes: 

```{r}
#| label: mean-sample
penguins |> 
  filter(seleccionado) |> 
  summarise(media_muestral = mean(bill_length_mm, na.rm = TRUE))
```

쯉on muy distintas?

Una medida de esta diferencia es el error relativo: 

$$\frac{|media_{pop} - media_{sample}|}{media_{pop}}$$


쮺u치l es la gracia? 

Pues que si tu tama침o muestral es muy peque침o, no hay ninguna garant칤a de que la media (o lo que est칠s midiendo) se parezca a la poblacional:

```{r}
penguins |> 
  slice_sample(n = 5) |> 
  summarise(media_muestral = mean(bill_length_mm, na.rm = TRUE))
```

Pero si dejas que el tama침o muestral crezca, tu c치lculo se estabilizar치. 

```{r}
#| label: evol-sample-error1
calcula_media <- function(size) {
  penguins |> 
    slice_sample(n = size, replace = FALSE) |> 
    summarise(media_muestral = mean(bill_length_mm, na.rm = TRUE)) |> 
    mutate(sample_size = size)
}

library(purrr)

df_medias <- map_dfr(seq_len(nrow(penguins)), calcula_media)
```


```{r}
#| label: evol-sample-error2
df_medias |> 
  mutate(media_total = mean(penguins$bill_length_mm, na.rm = TRUE), 
         error = abs(media_total - media_muestral) / media_total) |> 
  ggplot(aes(x = sample_size, y = error)) + 
  geom_line() + 
  geom_smooth(col = "#800080")+ 
  labs(y = "Error relativo", x = "Tama침o muestral")

```


[En unos d칤as](https://longitudsinanchura.com/posts/2023-07-21-muestreo-ii) te escribo sobre c칩mo aproximar esto cuando no tienes acceso a la media poblacional, pero que puedas valorar si tu muestra es adecuada o no.
